/*! fuzzy-finder-wp 2016-12-10 */
var ffwp_finder=ffwp_finder||{};jQuery(document).ready(function(a){ffwp_finder.init=function(){this.results=[],this.strings=[],this.urls=[],this.post_ids=[];var b=[],c=[];try{b=JSON.parse(localStorage.getItem("ffwp_finder_strings"))||[],c=JSON.parse(localStorage.getItem("ffwp_finder_urls"))||[],this.post_ids=JSON.parse(localStorage.getItem("ffwp_finder_post_ids"))||[],this.hasLocalStorage=!0}catch(d){this.hasLocalStorage=!1}this.strings=ffwp_finder_settings.strings.concat(b),this.urls=ffwp_finder_settings.urls.concat(c),this.status="waiting",this.searched_count=0,this.total_count=ffwp_finder.strings.length,this.cache=this.cache||{},this.cache.body=a("body"),this.cache.finder=a("#ffwp-finder"),this.cache.search=this.cache.finder.find("#ffwp-search"),this.cache.results=this.cache.finder.find(".ffwp-results"),this.cache.status=this.cache.finder.find(".ffwp-status"),this.cache.progress=this.cache.status.find(".ffwp-progress"),this.cache.body.on("keyup",this.handleShortcuts),this.cache.search.on("keyup",this.search),this.cache.finder.on("click",this.handleFinderWrapperEvents),this.cache.finder.on("ffwpSearchBegun",this.setStatusSearching),this.cache.finder.on("ffwpSearchFinished",this.setStatusComplete)},ffwp_finder.open=function(){ffwp_finder.cache.body.addClass("ffwp-finder-is-visible"),ffwp_finder.cache.finder.addClass("is-visible"),setTimeout(function(){ffwp_finder.cache.search.focus()},300)},ffwp_finder.close=function(){ffwp_finder.cache.body.removeClass("ffwp-finder-is-visible"),ffwp_finder.cache.finder.removeClass("is-visible"),setTimeout(function(){ffwp_finder.cache.search.val(""),ffwp_finder.clearResults(),ffwp_finder.setStatusWaiting()},300)},ffwp_finder.handleShortcuts=function(a){return a.ctrlKey&&a.shiftKey&&70==a.which?void ffwp_finder.open():27==a.which&&ffwp_finder.cache.finder.hasClass("is-visible")?void ffwp_finder.close():void 0},ffwp_finder.handleFinderWrapperEvents=function(a){"click"==a.type&&"ffwp-finder"==a.target.id&&ffwp_finder.close()},ffwp_finder.search=function(){var a=ffwp_finder.cache.search.val();if(a!==ffwp_finder.current_term){if(ffwp_finder.current_term=a,a.length<3)return ffwp_finder.clearResults(),void ffwp_finder.setStatusWaiting();for(var b=ffwp_finder.results.length-1;b>=0;b--)new RegExp(a,"i").test(ffwp_finder.strings[ffwp_finder.results[b]])||ffwp_finder.removeResult(ffwp_finder.results[b]);if(ffwp_finder.setStatusSearching(),"undefined"!==wp.api&&ffwp_finder_settings.post_types.length){var c=function(b,c,d){if(a===ffwp_finder.current_term&&b.length){var e=_.findWhere(ffwp_finder_settings.post_types,{post_type:b.at(0).get("type")}),f=ffwp_finder_settings.admin_url+"/"+e.edit_link+"&action=edit";b.forEach(function(a){var b=ffwp_finder.post_ids.indexOf(a.get("id"));0>b&&(b=ffwp_finder.strings.length),ffwp_finder.strings[b]=e.label+" > "+a.get("title").rendered,ffwp_finder.urls[b]=f.replace("%d",a.get("id")),ffwp_finder.post_ids[b]=a.get("id"),ffwp_finder.addResult(b,"live",!0)}),ffwp_finder.updateProgress(),ffwp_finder.updateLocalStorage()}},d=function(){a===ffwp_finder.current_term&&console.log("Error fetching posts. This error should probably be more helpful.")};for(var e in ffwp_finder_settings.post_types){var f,g=ffwp_finder_settings.post_types[e].post_type;f="post"===g?new wp.api.collections.Posts:"page"===g?new wp.api.collections.Pages:"attachment"===g?new wp.api.collections.Media:null,f&&f.fetch({data:{search:a,posts_per_page:100},error:d,success:c})}}var h=0,i=ffwp_finder.strings.length,j=function(){for(h;i>h;h++)if(new RegExp(a,"i").test(ffwp_finder.strings[h])&&ffwp_finder.addResult(h,"cache"),h+1>=i)h++,ffwp_finder.updateProgress(h),ffwp_finder.cache.finder.trigger("ffwpSearchFinished");else if(h%100===0){if(ffwp_finder.updateProgress(h),a!==ffwp_finder.current_term)break;setTimeout(j,0),h++;break}};j()}},ffwp_finder.addResult=function(a,b,c){if(-1!==ffwp_finder.results.indexOf(a)&&ffwp_finder.removeResult(a),!(ffwp_finder.results.length>100)){ffwp_finder.results.push(a);var d=ffwp_finder_settings.result_template.replace("{url}",ffwp_finder.urls[a]).replace("{string}",ffwp_finder.strings[a]).replace("{index}",a.toString()).replace("{class}",b);c?ffwp_finder.cache.results.prepend(d):ffwp_finder.cache.results.append(d)}},ffwp_finder.removeResult=function(a){var b=ffwp_finder.results.indexOf(a);b>-1&&ffwp_finder.results.splice(b,1),ffwp_finder.cache.results.find("#ffwp-result-"+a.toString()).remove(),ffwp_finder.updateProgress()},ffwp_finder.clearResults=function(){ffwp_finder.results=[],ffwp_finder.cache.results.empty()},ffwp_finder.setStatusFetching=function(){ffwp_finder.cache.status.removeClass("fetching complete waiting").addClass("fetching"),ffwp_finder.status="fetching",ffwp_finder.clearProgress()},ffwp_finder.setStatusSearching=function(){ffwp_finder.cache.status.removeClass("fetching complete waiting").addClass("searching"),ffwp_finder.status="searching"},ffwp_finder.setStatusComplete=function(){ffwp_finder.cache.status.removeClass("fetching searching waiting").addClass("complete"),ffwp_finder.status="complete"},ffwp_finder.setStatusWaiting=function(){ffwp_finder.cache.status.removeClass("fetching searching complete").addClass("waiting"),ffwp_finder.status="waiting",ffwp_finder.clearProgress()},ffwp_finder.updateProgress=function(a){this.searched_count+=a,"undefined"==typeof a||a===this.total_count?ffwp_finder.cache.progress.html(ffwp_finder.results.length+" matches"):ffwp_finder.cache.progress.html(a+"/"+this.total_count)},ffwp_finder.clearProgress=function(){ffwp_finder.cache.progress.empty()},ffwp_finder.updateLocalStorage=function(a){if(ffwp_finder.hasLocalStorage){var b=ffwp_finder.strings.slice(0);b.splice(0,ffwp_finder_settings.strings.length);var c=ffwp_finder.urls.slice(0);c.splice(0,ffwp_finder_settings.urls.length),b.length>1e3&&(b.splice(0,b.length-1e3),c.splice(0,c.length-1e3)),localStorage.setItem("ffwp_finder_strings",JSON.stringify(b)),localStorage.setItem("ffwp_finder_urls",JSON.stringify(c)),localStorage.setItem("ffwp_finder_post_ids",JSON.stringify(ffwp_finder.post_ids))}},ffwp_finder.init()});